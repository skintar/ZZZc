<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ –†–µ–π—Ç–∏–Ω–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            color: var(--tg-theme-text-color, white);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        h1 { font-size: 2.2em; margin-bottom: 8px; }
        h2 { font-size: 1.8em; margin-bottom: 15px; }
        .subtitle { opacity: 0.9; margin-bottom: 25px; font-size: 16px; }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            border: 2px solid transparent;
        }
        
        .btn:hover { 
            background: rgba(255, 255, 255, 0.3); 
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .btn.primary { 
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn.secondary { 
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .btn.outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .mode-grid {
            display: grid;
            gap: 15px;
            margin: 25px 0;
        }
        
        .mode-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: left;
        }
        
        .mode-card:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-3px);
        }
        
        .mode-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .mode-emoji {
            font-size: 2em;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }
        
        .mode-info h3 {
            font-size: 1.3em;
            margin-bottom: 4px;
        }
        
        .mode-stats {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .mode-description {
            font-size: 0.95em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            margin: 25px 0;
        }
        
        .character {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .character:hover { 
            background: rgba(255, 255, 255, 0.25); 
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .character.selected { 
            background: rgba(76, 175, 80, 0.4); 
            border-color: #4CAF50;
        }
        
        .character-img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .character-name {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .vs { 
            font-size: 1.8em; 
            font-weight: bold; 
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #81C784);
            height: 100%;
            transition: width 0.4s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            margin: 10px 0;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 16px;
            margin: 12px 0;
            border-radius: 15px;
            text-align: left;
        }
        
        .rank-number {
            background: rgba(255, 255, 255, 0.25);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .rank-gold { background: linear-gradient(45deg, #FFD700, #FFA000); }
        .rank-silver { background: linear-gradient(45deg, #C0C0C0, #9E9E9E); }
        .rank-bronze { background: linear-gradient(45deg, #CD7F32, #A0522D); }
        
        .motivational {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            font-style: italic;
            opacity: 0.9;
        }
        
        .stats-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 1000;
        }
        
        @media (max-width: 400px) {
            .container { padding: 20px; margin: 10px; }
            .comparison { gap: 10px; }
            .character-img { width: 70px; height: 70px; font-size: 2em; }
            h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="menu" class="screen active">
            <h1>üèÜ –†–µ–π—Ç–∏–Ω–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h1>
            <p class="subtitle">–°–æ–∑–¥–∞–π —Å–≤–æ–π —Ç–æ–ø —á–µ—Ä–µ–∑ –ø–∞—Ä–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è!</p>
            
            <button class="btn primary" onclick="showModeSelection()">
                üèÜ –°–æ–∑–¥–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥
            </button>
            <button class="btn secondary" onclick="showMyRanking()">
                üìä –ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥
            </button>
            <button class="btn outline" onclick="showDemo()">
                üéÜ –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            </button>
        </div>
        
        <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
        <div id="modeSelection" class="screen">
            <button class="back-btn" onclick="showMenu()">‚Üê</button>
            <h2>‚ö° –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –æ—Ü–µ–Ω–∫–∏</h2>
            <p class="subtitle">–ö–∞–∂–¥—ã–π —Ä–µ–∂–∏–º –¥–∞–µ—Ç —Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–µ—Ä–≤—ã—Ö –º–µ—Å—Ç</p>
            
            <div class="mode-grid">
                <div class="mode-card" onclick="startRating('quick')">
                    <div class="mode-header">
                        <div class="mode-emoji">‚ö°</div>
                        <div class="mode-info">
                            <h3>–ë—ã—Å—Ç—Ä—ã–π</h3>
                            <div class="mode-stats">3-5 –º–∏–Ω ‚Ä¢ 85-90% ‚Ä¢ 15 —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
                        </div>
                    </div>
                    <div class="mode-description">
                        –ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏.
                        –û—Ç–ª–∏—á–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø-3!
                    </div>
                </div>
                
                <div class="mode-card" onclick="startRating('medium')">
                    <div class="mode-header">
                        <div class="mode-emoji">üéØ</div>
                        <div class="mode-info">
                            <h3>–°—Ä–µ–¥–Ω–∏–π</h3>
                            <div class="mode-stats">6-9 –º–∏–Ω ‚Ä¢ 90-95% ‚Ä¢ 30 —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
                        </div>
                    </div>
                    <div class="mode-description">
                        –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å —Ö–æ—Ä–æ—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.
                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–µ–∂–∏–º!
                    </div>
                </div>
                
                <div class="mode-card" onclick="startRating('precise')">
                    <div class="mode-header">
                        <div class="mode-emoji">üèÜ</div>
                        <div class="mode-info">
                            <h3>–¢–æ—á–Ω—ã–π</h3>
                            <div class="mode-stats">12-18 –º–∏–Ω ‚Ä¢ 95-98% ‚Ä¢ 50 —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
                        </div>
                    </div>
                    <div class="mode-description">
                        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞.
                        –î–ª—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç–æ–≤!
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
        <div id="comparison" class="screen">
            <h2>–ö—Ç–æ —Ç–µ–±–µ –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?</h2>
            <div class="progress">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <p id="progressText">0 / 10</p>
            
            <div class="comparison">
                <div class="character" id="charA" onclick="selectCharacter('A')">
                    <div class="character-img" id="imgA">üé≠</div>
                    <div id="nameA">–ü–µ—Ä—Å–æ–Ω–∞–∂ –ê</div>
                </div>
                
                <div class="vs">VS</div>
                
                <div class="character" id="charB" onclick="selectCharacter('B')">
                    <div class="character-img" id="imgB">üé™</div>
                    <div id="nameB">–ü–µ—Ä—Å–æ–Ω–∞–∂ –ë</div>
                </div>
            </div>
            
            <button class="btn" onclick="skipComparison()">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn secondary" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –†–µ–π—Ç–∏–Ω–≥ -->
        <div id="ranking" class="screen">
            <h2>üèÜ –¢–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥</h2>
            <div id="rankingList"></div>
            <button class="btn primary" onclick="showMenu()">üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
        </div>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
            if (tg.themeParams.bg_color) {
                document.body.style.background = tg.themeParams.bg_color;
            }
        }
        
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç config.py)
        const characters = [
            { name: '–°–æ–ª–¥–∞—Ç 0', emoji: 'ü§ñ' },
            { name: '–°–æ–ª–¥–∞—Ç 11', emoji: 'üî´' },
            { name: '–≠–Ω–±–∏', emoji: '‚ö°' },
            { name: '–ù–∏–∫–æ–ª—å', emoji: 'üíº' },
            { name: '–ë–∏–ª–ª–∏', emoji: 'üé™' },
            { name: '–ù—ç–∫–æ–º–∞—Ç–∞', emoji: 'üê±' },
            { name: '–ö–æ–ª—è–¥–∞', emoji: 'üéÑ' },
            { name: '–ë–µ–Ω', emoji: 'üêª' },
            { name: '–ê–Ω—Ç–æ–Ω', emoji: 'üîß' },
            { name: '–ì—Ä–µ–π—Å', emoji: 'üíÉ' },
            { name: '–õ–∏–∫–∞–æ–Ω', emoji: 'üê∫' },
            { name: '–≠–ª–ª–µ–Ω', emoji: 'ü¶à' },
            { name: '–ö–æ—Ä–∏–Ω', emoji: 'üß∏' },
            { name: '–†–∏–Ω–∞', emoji: '‚öôÔ∏è' },
            { name: '–ë—ë—Ä–Ω–∏—Å', emoji: 'üî•' },
            { name: '–¶–µ–∑–∞—Ä—å', emoji: 'üëë' },
            { name: '–õ—é—Å–∏', emoji: 'üíé' },
            { name: '–ü–∞–π–ø–µ—Ä', emoji: 'üéµ' },
            { name: '–õ–∞–π—Ç–µ—Ä', emoji: 'üöó' },
            { name: '–ü—É–ª—å—Ö—Ä–∞', emoji: '‚ú®' },
            { name: '–ú–∏—è–±–∏', emoji: 'üå∏' },
            { name: '–•–∞—Ä—É–º–∞—Å–∞', emoji: 'üéØ' },
            { name: '–Ø–Ω–∞–≥–∏', emoji: '‚öñÔ∏è' },
            { name: '–°–æ–∫–∞–∫—É', emoji: '‚ùÑÔ∏è' },
            { name: '–ß–∂—É –Æ–∞–Ω—å', emoji: 'üèõÔ∏è' },
            { name: '–¶–∏–Ω—ä–∏', emoji: '‚öîÔ∏è' },
            { name: '–î–∂–µ–π–Ω', emoji: 'üï∑Ô∏è' },
            { name: '–ê—Å—Ç—Ä–∞', emoji: 'üåü' },
            { name: '–≠–≤–µ–ª–∏–Ω', emoji: 'üé≠' },
            { name: '–í–∏–≤–∏–∞–Ω', emoji: 'üé®' },
            { name: '–•—É–≥–æ', emoji: 'üèóÔ∏è' },
            { name: '–ì–∞—à–µ—Ç–∫–∞', emoji: 'üîó' },
            { name: '–ü–∞–Ω—å –ò–Ω—å—Ö—É', emoji: 'üêÖ' },
            { name: '–ò—Å—é–∞–Ω—å', emoji: 'üåô' },
            { name: '–§—É—Ñ—É', emoji: 'üå∫' },
            { name: '–Æ–¥–∑—É—Ö–∞', emoji: 'üçÉ' },
            { name: '–°–µ—Ç', emoji: 'üè∫' },
            { name: '–ë–µ–ª–ª—å', emoji: 'üìö' },
            { name: '–í–∞–π–∑', emoji: 'üî¨' },
            { name: '–°–∏–¥', emoji: 'üí§' },
            { name: '–≠–ª–∏—Å', emoji: 'üéÄ' },
            { name: '–û—Ä—Ñ–µ–π', emoji: 'üéº' },
            { name: '–ú–∞–Ω–∞—Ç–æ', emoji: 'üé®' }
        ];
        
        // –†–µ–∂–∏–º—ã –æ—Ü–µ–Ω–∫–∏ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç config.py)
        const evaluationModes = {
            'quick': {
                name: '‚ö° –ë—ã—Å—Ç—Ä—ã–π (–¥–æ 5 –º–∏–Ω)',
                description: '–ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏',
                max_comparisons: 15,
                estimated_time: '3-5 –º–∏–Ω—É—Ç',
                accuracy: '85-90%',
                emoji: '‚ö°'
            },
            'medium': {
                name: 'üéØ –°—Ä–µ–¥–Ω–∏–π (5-10 –º–∏–Ω)',
                description: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å —Ö–æ—Ä–æ—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é',
                max_comparisons: 30,
                estimated_time: '6-9 –º–∏–Ω—É—Ç',
                accuracy: '90-95%',
                emoji: 'üéØ'
            },
            'precise': {
                name: 'üèÜ –¢–æ—á–Ω—ã–π (10-20 –º–∏–Ω)',
                description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞',
                max_comparisons: 50,
                estimated_time: '12-18 –º–∏–Ω—É—Ç',
                accuracy: '95-98%',
                emoji: 'üèÜ'
            }
        };
        
        // –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Ñ—Ä–∞–∑—ã (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç config.py)
        const motivationalPhrases = [
            "‚ú® –¢—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è!",
            "üéØ –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –∫ –∏–¥–µ–∞–ª—å–Ω–æ–º—É —Ä–µ–π—Ç–∏–Ω–≥—É!",
            "üåü –¢–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã!",
            "üí´ –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
            "üé™ –¢—ã —Å–æ–∑–¥–∞–µ—à—å —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ!",
            "üî• –¢–≤–æ—è –∏–Ω—Ç—É–∏—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!",
            "üå∏ –ö–∞–∂–¥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –ª—É—á—à–µ!",
            "‚≠ê –¢—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏!",
            "üé≠ –¢–≤–æ–∏ –≤–∫—É—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø!",
            "üåà –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –≤–∞–∂–µ–Ω –∏ —Ü–µ–Ω–µ–Ω!"
        ];
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (–∞–Ω–∞–ª–æ–≥ SimpleTransitiveSession)
        let currentSession = null;
        let currentMode = null;
        
        // ========================
        // üéÜ –ö–õ–ê–°–° üéÜ TransitiveSession - –ü–æ–ª–Ω–∞—è –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
        // ========================
        class TransitiveSession {
            constructor(charactersCount, maxComparisons = null) {
                this.charactersCount = charactersCount;
                this.maxComparisons = maxComparisons;
                
                // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω—ã–µ)
                this.wins = new Set(); // (winner, loser)
                
                // –¢–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: key=(min(a,b), max(a,b)), value=winner
                this.results = new Map();
                
                // –ê–¥–∂. —Å–ø–∏—Å–∫–∏ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–º—ã–∫–∞–Ω–∏—é
                this.adjFwd = new Map(); // winner -> losers
                this.adjRev = new Map(); // loser -> winners
                
                // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏
                this.winCounts = new Map();
                this.compCounts = new Map();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤
                for (let i = 0; i < charactersCount; i++) {
                    this.winCounts.set(i, 0);
                    this.compCounts.set(i, 0);
                    this.adjFwd.set(i, new Set());
                    this.adjRev.set(i, new Set());
                }
                
                this.comparisonsMade = 0;
                this.choiceHistory = [];
                this.currentPair = null;
                
                // –í—Å–µ –µ—â—ë –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä—ã (min, max)
                this.unknownPairs = new Set();
                for (let a = 0; a < charactersCount; a++) {
                    for (let b = a + 1; b < charactersCount; b++) {
                        this.unknownPairs.add(`${a},${b}`);
                    }
                }
                
                // –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏
                this.learnedPreferences = new Map();
            }
            
            get isCompleted() {
                if (this.maxComparisons !== null && this.comparisonsMade >= this.maxComparisons) {
                    return true;
                }
                return this.unknownPairs.size === 0;
            }
            
            get totalPairs() {
                return this.maxComparisons || (this.charactersCount * (this.charactersCount - 1)) / 2;
            }
            
            getCurrentPair() {
                if (this.isCompleted) {
                    this.currentPair = null;
                    return null;
                }
                if (this.currentPair === null) {
                    this.currentPair = this.selectNextPair();
                }
                return this.currentPair;
            }
            
            recordChoice(pair, winner) {
                if (!pair) return;
                
                const [a, b] = pair;
                if (![a, b].includes(winner)) {
                    throw new Error('winner must be one of pair');
                }
                
                const mn = Math.min(a, b);
                const mx = Math.max(a, b);
                const pairKey = `${mn},${mx}`;
                
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä—è–º–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ ‚Äî –∏–≥–Ω–æ—Ä
                if (this.results.has(pairKey)) {
                    this.currentPair = null;
                    return;
                }
                
                const loser = (winner === a) ? b : a;
                
                // –ï—Å–ª–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ ‚Äì —Ç–æ–∂–µ –∏–≥–Ω–æ—Ä
                const winKey = `${winner},${loser}`;
                if (this.wins.has(winKey)) {
                    this.results.set(pairKey, winner);
                    this.comparisonsMade++;
                    this.compCounts.set(a, this.compCounts.get(a) + 1);
                    this.compCounts.set(b, this.compCounts.get(b) + 1);
                    this.choiceHistory.push([pairKey, winner]);
                    this.learnFromChoice([mn, mx], winner);
                    this.unknownPairs.delete(pairKey);
                    this.currentPair = null;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤–µ–¥—ë—Ç –ª–∏ –∫ —Ü–∏–∫–ª—É
                if (this.isReachable(loser, winner)) {
                    // –ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: —Å–æ–∑–¥–∞—Å—Ç —Ü–∏–∫–ª
                    this.results.set(pairKey, winner);
                    this.comparisonsMade++;
                    this.compCounts.set(a, this.compCounts.get(a) + 1);
                    this.compCounts.set(b, this.compCounts.get(b) + 1);
                    this.choiceHistory.push([pairKey, winner]);
                    this.learnFromChoice([mn, mx], winner);
                    this.unknownPairs.delete(pairKey);
                    this.currentPair = null;
                    return;
                }
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
                this.results.set(pairKey, winner);
                this.comparisonsMade++;
                this.compCounts.set(a, this.compCounts.get(a) + 1);
                this.compCounts.set(b, this.compCounts.get(b) + 1);
                this.choiceHistory.push([pairKey, winner]);
                this.learnFromChoice([mn, mx], winner);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∏ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–ª–µ–¥—Å—Ç–≤–∏—è
                this.addRelationWithClosure(winner, loser);
                
                this.currentPair = null;
            }
            
            addRelationWithClosure(u, v) {
                // –ù–∞–π–¥—ë–º –≤—Å–µ—Ö –ø—Ä–µ–¥–∫–æ–≤ u (–≤–∫–ª—é—á–∞—è u) –∏ –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤ v (–≤–∫–ª—é—á–∞—è v)
                const ancestors = this.collectAncestorsInclusive(u);
                const descendants = this.collectDescendantsInclusive(v);
                
                // –î–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã (a, b) –¥–æ–±–∞–≤–∏–º —Ä–µ–±—Ä–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
                for (const a of ancestors) {
                    for (const b of descendants) {
                        if (a === b) continue;
                        
                        const winKey = `${a},${b}`;
                        if (this.wins.has(winKey)) continue;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ä–µ–±—Ä–æ –≤ –∑–∞–º—ã–∫–∞–Ω–∏–µ
                        this.wins.add(winKey);
                        this.adjFwd.get(a).add(b);
                        this.adjRev.get(b).add(a);
                        
                        // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø–æ–±–µ–¥
                        this.winCounts.set(a, this.winCounts.get(a) + 1);
                        
                        // –ü–∞—Ä–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏–∑–≤–µ—Å—Ç–Ω–æ–π ‚Äî —É–±—Ä–∞—Ç—å –∏–∑ unknown
                        const mn = Math.min(a, b);
                        const mx = Math.max(a, b);
                        this.unknownPairs.delete(`${mn},${mx}`);
                    }
                }
            }
            
            collectAncestorsInclusive(x) {
                const res = new Set([x]);
                const queue = [x];
                
                while (queue.length > 0) {
                    const cur = queue.shift();
                    const parents = this.adjRev.get(cur) || new Set();
                    for (const p of parents) {
                        if (!res.has(p)) {
                            res.add(p);
                            queue.push(p);
                        }
                    }
                }
                return res;
            }
            
            collectDescendantsInclusive(x) {
                const res = new Set([x]);
                const queue = [x];
                
                while (queue.length > 0) {
                    const cur = queue.shift();
                    const children = this.adjFwd.get(cur) || new Set();
                    for (const ch of children) {
                        if (!res.has(ch)) {
                            res.add(ch);
                            queue.push(ch);
                        }
                    }
                }
                return res;
            }
            
            isReachable(src, dst) {
                if (src === dst) return true;
                return this.wins.has(`${src},${dst}`);
            }
            
            learnFromChoice(pair, winner) {
                if (!pair || pair.length !== 2) return;
                
                const [a, b] = pair;
                if (!(0 <= a && a < this.charactersCount && 0 <= b && b < this.charactersCount)) return;
                if (![a, b].includes(winner)) return;
                
                const loser = (winner === a) ? b : a;
                const keyAB = `${a},${b}`;
                const keyBA = `${b},${a}`;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                if (!this.learnedPreferences.has(keyAB)) {
                    this.learnedPreferences.set(keyAB, 0.5);
                }
                if (!this.learnedPreferences.has(keyBA)) {
                    this.learnedPreferences.set(keyBA, 0.5);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
                const learningRate = 0.1;
                if (winner === a) {
                    this.learnedPreferences.set(keyAB, Math.min(1.0, this.learnedPreferences.get(keyAB) + learningRate));
                    this.learnedPreferences.set(keyBA, Math.max(0.0, this.learnedPreferences.get(keyBA) - learningRate));
                } else {
                    this.learnedPreferences.set(keyBA, Math.min(1.0, this.learnedPreferences.get(keyBA) + learningRate));
                    this.learnedPreferences.set(keyAB, Math.max(0.0, this.learnedPreferences.get(keyAB) - learningRate));
                }
            }
            
            getLearnedPreference(a, b) {
                if (!(0 <= a && a < this.charactersCount && 0 <= b && b < this.charactersCount)) return 0.5;
                if (a === b) return 0.5;
                return this.learnedPreferences.get(`${a},${b}`) || 0.5;
            }
            
            selectNextPair() {
                if (this.unknownPairs.size === 0) return null;
                
                // –†–∞–Ω–Ω–∏–µ —à–∞–≥–∏ ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –ø–∞—Ä–∞
                if (this.comparisonsMade < 10) {
                    const pairs = Array.from(this.unknownPairs);
                    const randomPair = pairs[Math.floor(Math.random() * pairs.length)];
                    const [a, b] = randomPair.split(',').map(Number);
                    return [a, b];
                }
                
                // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞ –ø–æ–¥–≤—ã–±–æ—Ä–∫–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                const candidates = this.sampleUnknown(200);
                
                if (candidates.length === 0) {
                    const pairs = Array.from(this.unknownPairs);
                    const randomPair = pairs[Math.floor(Math.random() * pairs.length)];
                    const [a, b] = randomPair.split(',').map(Number);
                    return [a, b];
                }
                
                const scored = [];
                for (const candidatePair of candidates) {
                    const [a, b] = candidatePair.split(',').map(Number);
                    const winDiff = Math.abs(this.winCounts.get(a) - this.winCounts.get(b));
                    const compSum = this.compCounts.get(a) + this.compCounts.get(b);
                    const learnedPref = this.getLearnedPreference(a, b);
                    const uncertainty = Math.abs(learnedPref - 0.5);
                    
                    // –ß–µ–º –º–µ–Ω—å—à–µ score ‚Äî —Ç–µ–º –ª—É—á—à–µ
                    let score;
                    if (compSum === 0) {
                        score = 1000 + winDiff - uncertainty * 100;
                    } else if (compSum < 3) {
                        score = 500 + winDiff - uncertainty * 50;
                    } else {
                        score = winDiff - uncertainty * 200 + Math.max(0, 5 - Math.abs(compSum - 6));
                    }
                    scored.push([score, a, b]);
                }
                
                scored.sort((x, y) => x[0] - y[0]);
                const topCount = Math.max(1, Math.floor(scored.length / 3));
                const randomChoice = scored[Math.floor(Math.random() * topCount)];
                return [randomChoice[1], randomChoice[2]];
            }
            
            sampleUnknown(k) {
                if (this.unknownPairs.size === 0) return [];
                if (this.unknownPairs.size <= k) return Array.from(this.unknownPairs);
                
                const pairsArray = Array.from(this.unknownPairs);
                const result = [];
                for (let i = 0; i < k; i++) {
                    result.push(pairsArray[Math.floor(Math.random() * pairsArray.length)]);
                }
                return result;
            }
            
            calculateScores() {
                const scores = [];
                for (let idx = 0; idx < this.charactersCount; idx++) {
                    scores.push([this.winCounts.get(idx), idx]);
                }
                return scores.sort((a, b) => b[0] - a[0]);
            }
            
            getStatistics() {
                const denom = this.totalPairs || 1;
                return {
                    comparisonsMade: this.comparisonsMade,
                    maxComparisons: this.maxComparisons,
                    totalRelations: this.wins.size,
                    completionPercentage: Math.min(100.0, (this.comparisonsMade / denom) * 100.0)
                };
            }
        }
        
        // ========================
        // üéÜ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò üéÜ
        // ========================
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showMenu() {
            showScreen('menu');
            currentSession = null;
            currentMode = null;
        }
        
        function showModeSelection() {
            showScreen('modeSelection');
        }
        
        // –ù–∞—á–∞–ª–æ –æ—Ü–µ–Ω–∫–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º
        function startRating(mode) {
            currentMode = evaluationModes[mode];
            currentSession = new TransitiveSession(characters.length, currentMode.max_comparisons);
            
            console.log(`üéØ –ù–∞—á–∞–ª–æ –æ—Ü–µ–Ω–∫–∏ –≤ —Ä–µ–∂–∏–º–µ: ${currentMode.name}`);
            console.log(`üî¢ –ú–∞–∫—Å. —Å—Ä–∞–≤–Ω–µ–Ω–∏–π: ${currentMode.max_comparisons}`);
            
            nextComparison();
            showScreen('comparison');
        }
        
        function showMyRanking() {
            if (!currentSession || currentSession.comparisonsMade === 0) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –¥–µ–º–æ
                const shuffled = [...characters].sort(() => Math.random() - 0.5);
                displayRanking(shuffled.map((char, index) => ({
                    ...char,
                    score: Math.round((characters.length - index) * 10 + Math.random() * 10),
                    wins: Math.floor(Math.random() * 20),
                    comparisons: Math.floor(Math.random() * 30)
                })));
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                const ranking = generateRanking();
                displayRanking(ranking);
            }
            showScreen('ranking');
        }
        
        function showDemo() {
            alert('üéÆ –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!\n\nüèÜ –°–æ–∑–¥–∞–π —Å–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!\n\n‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n‚Ä¢ 3 —Ä–µ–∂–∏–º–∞ –æ—Ü–µ–Ω–∫–∏\n‚Ä¢ –£–º–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏–π\n‚Ä¢ –¢—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ\n‚Ä¢ –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Ñ—Ä–∞–∑—ã\n\nüöÄ –ù–∞—á–Ω–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!');
        }
        
        // ========================
        // üéÜ –õ–û–ì–ò–ö–ê –°–†–ê–í–ù–ï–ù–ò–ô üéÜ
        // ========================
        
        function nextComparison() {
            if (!currentSession || currentSession.isCompleted) {
                showRanking();
                return;
            }
            
            const pair = currentSession.getCurrentPair();
            if (!pair) {
                showRanking();
                return;
            }
            
            const [charAIndex, charBIndex] = pair;
            const charA = characters[charAIndex];
            const charB = characters[charBIndex];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('imgA').textContent = charA.emoji;
            document.getElementById('nameA').textContent = charA.name;
            document.getElementById('imgB').textContent = charB.emoji;
            document.getElementById('nameB').textContent = charB.name;
            
            updateProgress();
            
            // –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∞—è —Ñ—Ä–∞–∑–∞ –∫–∞–∂–¥—ã–µ 5 —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
            if (currentSession.comparisonsMade > 0 && currentSession.comparisonsMade % 5 === 0) {
                showMotivationalPhrase();
            }
        }
        
        function selectCharacter(choice) {
            if (!currentSession) return;
            
            const pair = currentSession.getCurrentPair();
            if (!pair) return;
            
            const [charAIndex, charBIndex] = pair;
            const selected = choice === 'A' ? charAIndex : charBIndex;
            
            try {
                currentSession.recordChoice(pair, selected);
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                const selectedEl = document.getElementById('char' + choice);
                selectedEl.classList.add('selected');
                
                setTimeout(() => {
                    selectedEl.classList.remove('selected');
                    nextComparison();
                }, 500);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤—ã–±–æ—Ä–∞:', error);
                nextComparison(); // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É
            }
        }
        
        function skipComparison() {
            if (!currentSession) return;
            nextComparison();
        }
        
        function goBack() {
            // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é
            showMenu();
        }
        
        function updateProgress() {
            if (!currentSession) return;
            
            const progress = (currentSession.comparisonsMade / currentSession.totalPairs) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${currentSession.comparisonsMade} / ${currentSession.maxComparisons || '?'}`;
        }
        
        function showMotivationalPhrase() {
            const phrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];
            
            // –°–æ–∑–¥–∞—ë–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const motivationalEl = document.createElement('div');
            motivationalEl.className = 'motivational';
            motivationalEl.textContent = phrase;
            motivationalEl.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 20px;
                border-radius: 15px;
                font-size: 16px;
                font-weight: bold;
                text-align: center;
                z-index: 2000;
                animation: fadeInOut 3s ease-in-out;
                max-width: 300px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
            if (!document.getElementById('motivationalAnimation')) {
                const style = document.createElement('style');
                style.id = 'motivationalAnimation';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(motivationalEl);
            
            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (motivationalEl.parentNode) {
                    motivationalEl.parentNode.removeChild(motivationalEl);
                }
            }, 3000);
        }
        
        // ========================
        // üéÜ –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ô–¢–ò–ù–ì–ê üéÜ
        // ========================
        
        function generateRanking() {
            if (!currentSession || currentSession.comparisonsMade === 0) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –¥–µ–º–æ
                return characters.map((char, index) => ({
                    ...char,
                    score: Math.round((characters.length - index) * 10 + Math.random() * 10),
                    wins: Math.floor(Math.random() * 20),
                    comparisons: Math.floor(Math.random() * 30)
                })).sort(() => Math.random() - 0.5);
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
            const scores = currentSession.calculateScores();
            
            return scores.map(([totalWins, characterIndex], place) => {
                const character = characters[characterIndex];
                const directWins = Array.from(currentSession.results.entries())
                    .filter(([key, winner]) => winner === characterIndex).length;
                
                // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ–π—Ç–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–±–µ–¥
                const rating = totalWins;
                
                return {
                    place: place + 1,
                    name: character.name,
                    emoji: character.emoji,
                    score: rating,
                    wins: directWins,
                    comparisons: currentSession.compCounts.get(characterIndex) || 0
                };
            });
        }
        
        function showRanking() {
            const ranking = generateRanking();
            displayRanking(ranking);
            showScreen('ranking');
        }
        
        function displayRanking(ranking) {
            const container = document.getElementById('rankingList');
            container.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∂–∏–º–µ
            if (currentMode) {
                const modeInfo = document.createElement('div');
                modeInfo.className = 'motivational';
                modeInfo.style.cssText = 'margin-bottom: 20px; text-align: center; font-size: 14px;';
                modeInfo.innerHTML = `
                    ${currentMode.emoji} <strong>–†–µ–∂–∏–º:</strong> ${currentMode.name}<br>
                    üéØ <strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong> ${currentMode.accuracy}<br>
                    ${currentSession ? `üî¢ <strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–π:</strong> ${currentSession.comparisonsMade}` : ''}
                `;
                container.appendChild(modeInfo);
            }
            
            ranking.slice(0, 15).forEach((char, index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                // –û—Å–æ–±—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è —Ç–æ–ø-3
                let rankEmoji = '';
                let rankClass = '';
                if (index === 0) {
                    rankEmoji = 'ü•á';
                    rankClass = 'rank-gold';
                } else if (index === 1) {
                    rankEmoji = 'ü•à';
                    rankClass = 'rank-silver';
                } else if (index === 2) {
                    rankEmoji = 'ü•â';
                    rankClass = 'rank-bronze';
                } else if (index < 10) {
                    rankEmoji = '‚≠ê';
                } else {
                    rankEmoji = 'üî∏';
                }
                
                item.innerHTML = `
                    <div class="rank-number ${rankClass}">${rankEmoji}</div>
                    <div class="character-img" style="width: 40px; height: 40px; margin-right: 15px; font-size: 1.5em;">${char.emoji}</div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; font-size: 16px;">${char.place}. ${char.name}</div>
                        <div style="font-size: 12px; opacity: 0.7;">
                            üèÜ ${char.wins || 0} –ø–æ–±–µ–¥ ‚Ä¢ üìä ${char.score || 0} –æ—á–∫–æ–≤
                            ${char.comparisons > 0 ? ` ‚Ä¢ üî¢ ${char.comparisons} —Å—Ä–∞–≤–Ω.` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ –ø–æ–ª–Ω–æ–º —Ä–µ–π—Ç–∏–Ω–≥–µ
            if (ranking.length > 15) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = 'text-align: center; padding: 20px; opacity: 0.7; font-size: 14px;';
                moreInfo.innerHTML = `–ò –µ—â—ë ${ranking.length - 15} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π...<br>üéÆ –û—Ü–µ–Ω–∏ –±–æ–ª—å—à–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞!`;
                container.appendChild(moreInfo);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (currentSession && currentSession.comparisonsMade > 0) {
                const stats = currentSession.getStatistics();
                const statsInfo = document.createElement('div');
                statsInfo.className = 'stats-info';
                statsInfo.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.comparisonsMade}</div>
                        <div class="stat-label">–°—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(stats.completionPercentage)}%</div>
                        <div class="stat-label">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                    </div>
                `;
                container.appendChild(statsInfo);
            }
        }
        
        // ========================
        // üéÜ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø üéÜ
        // ========================
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        console.log('üèÜ TMA –†–µ–π—Ç–∏–Ω–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('üì± Telegram WebApp:', !!tg);
        console.log('üéØ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ:', characters.length);
        console.log('‚öôÔ∏è –†–µ–∂–∏–º—ã –æ—Ü–µ–Ω–∫–∏:', Object.keys(evaluationModes));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
        const testSession = new TransitiveSession(5, 10);
        console.log('üß™ –¢–µ—Å—Ç TransitiveSession:', testSession.isCompleted ? '‚ùå' : '‚úÖ');
        console.log('üî¢ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–∞—Ä:', testSession.unknownPairs.size);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
        showScreen('menu');
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        if (tg) {
            console.log('üì° TMA –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!');
        }
    </script>
</body>
</html>